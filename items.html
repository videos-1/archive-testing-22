<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Archive User Items</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --bg:#020617;
  --card:#0f172a;
  --border:#334155;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --accent:#38bdf8;
}

body{
  margin:0;
  font-family:system-ui, monospace;
  background:var(--bg);
  color:var(--text);
}

header{
  text-align:center;
  padding:1rem;
  border-bottom:1px solid var(--border);
}

button{
  background:#1e293b;
  color:var(--text);
  border:none;
  padding:0.45rem 0.9rem;
  border-radius:6px;
  cursor:pointer;
}

select, input{
  background:#1e293b;
  color:var(--text);
  border:1px solid var(--border);
  padding:0.45rem;
  border-radius:6px;
  margin:0.25rem;
}

#log{
  margin:1rem;
  padding:1rem;
  border:1px solid var(--border);
  background:#020617;
  max-height:140px;
  overflow-y:auto;
  font-size:0.85rem;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(300px,1fr));
  gap:1rem;
  padding:1rem;
}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:8px;
  padding:0.8rem;
  display:flex;
  flex-direction:column;
  gap:0.5rem;
}

.card h3{
  font-size:1rem;
  margin:0;
  color:var(--accent);
}

.preview{
  width:100%;
  height:180px;
  border-radius:6px;
  overflow:hidden;
  border:1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  background: #1e293b;
}

.preview img{
  width:100%;
  height:100%;
  object-fit:cover;
}

.meta{
  font-size:0.78rem;
  color:var(--muted);
  line-height:1.35;
}

.meta.description {
  white-space: pre-wrap;
  word-break: break-word;
}

.open-btn{
  margin-top:auto;
  align-self:flex-start;
  background:#0284c7;
}

.share-btn{
  margin-top:auto;
  align-self:flex-start;
  background:#059669;
  margin-right: 0.5rem;
}

/* fullscreen viewer */
.fullscreen-overlay {
  position: fixed;
  inset: 0;
  width: 100vw;
  height: 100vh;
  background: #000;
  z-index: 999999;
  display: flex;
  flex-direction: column;
}

.fullscreen-overlay iframe{
  width:100vw;
  height:100vh;
  border:0;
}

.close-btn{
  position:fixed;
  top:15px;
  right:15px;
  z-index:1000000;
  background:rgba(255, 0, 0, 0.8);
  width:30px;
  height:30px;
  border-radius:50%;
  font-size:16px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  border:none;
  color:white;
}

.search-container{
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:0.5rem;
  padding:1rem;
  align-items:center;
}

.search-container > * {
  margin: 0.25rem;
}

.media-filter{
  display:flex;
  justify-content:center;
  padding:0 1rem 1rem;
  flex-wrap:wrap;
  gap:0.5rem;
}

.profile-header {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 1rem;
  margin-bottom: 1rem;
}

.profile-avatar {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid var(--accent);
  cursor: pointer;
}

.avatar-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 10000;
}

.avatar-overlay img {
  max-width: 90%;
  max-height: 90%;
  border: 2px solid var(--accent);
  border-radius: 8px;
}

.avatar-overlay .close-btn {
  position: absolute;
  top: 20px;
  right: 20px;
  background: #dc2626;
  border: none;
  color: white;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  font-size: 20px;
  cursor: pointer;
}

.load-more {
  display: block;
  margin: 1rem auto;
  padding: 0.7rem 1.5rem;
  background: #0284c7;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 1rem;
}
</style>
</head>

<body>

<header>
  <div class="profile-header">
    <img id="profileAvatar" class="profile-avatar" src="" alt="Profile Avatar">
    <h2 id="creatorName">User Archive Uploads</h2>
  </div>
  <button onclick="goBack()">‚Üê Back</button>
  
  <div class="search-container">
    <select id="searchType">
      <option value="title">Title</option>
      <option value="subject">Tags</option>
    </select>
    <input type="text" id="searchInput" placeholder="Enter search term">
    <button onclick="performSearch()">Search</button>
  </div>
  
  <div class="media-filter">
    <select id="mediaTypeFilter">
      <option value="">All Media Types</option>
      <option value="texts">Texts</option>
      <option value="movies">Movies</option>
      <option value="audio">Audio</option>
      <option value="software">Software</option>
      <option value="image">Image</option>
      <option value="data">Data</option>
      <option value="collection">Collection</option>
      <option value="web">Web</option>
    </select>
    <button onclick="filterByMediaType()">OK</button>
  </div>
</header>

<div id="log"></div>
<div class="grid" id="grid"></div>
<button id="loadMoreBtn" class="load-more" style="display: none;" onclick="renderNextBatch()">Load More</button>

<div class="avatar-overlay" id="avatarOverlay">
  <button class="close-btn" onclick="closeAvatar()">‚úï</button>
  <img id="avatarFullscreen" src="" alt="Full Avatar">
</div>

<script>
const logBox = document.getElementById("log");
const grid = document.getElementById("grid");
const searchInput = document.getElementById("searchInput");
const searchType = document.getElementById("searchType");
const mediaTypeFilter = document.getElementById("mediaTypeFilter");
const profileAvatar = document.getElementById("profileAvatar");
const creatorName = document.getElementById("creatorName");
const avatarOverlay = document.getElementById("avatarOverlay");
const avatarFullscreen = document.getElementById("avatarFullscreen");
const loadMoreBtn = document.getElementById("loadMoreBtn");

let allItems = [];
let visibleItems = [];
const PAGE_SIZE = 30;
let pageIndex = 0;

function getArchiveThumbnail(identifier) {
  return `https://archive.org/services/img/${identifier}`;
}

// IntersectionObserver for lazy loading thumbnails
const thumbnailObserver = new IntersectionObserver(
  (entries, observer) => {
    entries.forEach(entry => {
      if (!entry.isIntersecting) return;

      const container = entry.target;
      const thumbnailUrl = container.dataset.thumb;

      // Prevent re-loading
      if (container.dataset.loaded) return;

      container.innerHTML = `<img src="${thumbnailUrl}" alt="Thumbnail" loading="lazy">`;
      container.dataset.loaded = "1";

      observer.unobserve(container);
    });
  },
  {
    rootMargin: "200px",
    threshold: 0.1
  }
);

function goBack(){
  window.location.href = "index.html";
}

function log(msg){
  const d=document.createElement("div");
  d.textContent=msg;
  logBox.appendChild(d);
  logBox.scrollTop=logBox.scrollHeight;
}

function openViewer(directUrl) {
  document.body.style.overflow = "hidden";

  const overlay = document.createElement("div");
  overlay.className = "fullscreen-overlay";

  const closeBtn = document.createElement("button");
  closeBtn.className = "close-btn";
  closeBtn.innerHTML = "‚úï";
  closeBtn.style.background = "rgba(255, 0, 0, 0.8)";
  closeBtn.onclick = () => {
    document.body.style.overflow = "";
    document.body.removeChild(overlay);
  };

  const iframeContainer = document.createElement("div");
  iframeContainer.className = "embed-container";
  iframeContainer.innerHTML = `
    <iframe
      src="${directUrl}"
      allowfullscreen
      style="width:100vw;height:100vh;border:0"
    ></iframe>
  `;

  overlay.appendChild(closeBtn);
  overlay.appendChild(iframeContainer);
  document.body.appendChild(overlay);
}

function closeViewer(){
  document.body.style.overflow = "";
  const overlay = document.querySelector(".fullscreen-overlay");
  if (overlay) {
    document.body.removeChild(overlay);
  }
}

function openAvatar() {
  avatarFullscreen.src = profileAvatar.src;
  avatarOverlay.style.display = "flex";
}

function closeAvatar() {
  avatarOverlay.style.display = "none";
}

function shareItem(username, identifier) {
  const shareUrl = `https://yan-1-related-1.github.io/yan-1-website-shared-links-redirecting/archive-identifier-page-shared-links-redirecting.html?username=${username}&identifier=${identifier}`;
  
  if (navigator.share) {
    navigator.share({
      title: 'Check out this item',
      url: shareUrl
    }).catch(error => {
      log(`‚ùå Sharing failed: ${error}`);
    });
  } else {
    navigator.clipboard.writeText(shareUrl).then(() => {
      log(`‚úÖ Link copied to clipboard: ${identifier}`);
    }).catch(err => {
      log(`‚ùå Failed to copy link: ${err}`);
    });
  }
}

function normalizeDescription(desc) {
  if (!desc) return "";

  if (Array.isArray(desc)) {
    desc = desc.join("\n\n");
  }

  desc = desc.toString();
  const textarea = document.createElement("textarea");
  textarea.innerHTML = desc;
  desc = textarea.value;
  desc = desc.replace(/<\/?[^>]+(>|$)/g, "");
  desc = desc.replace(/\r\n/g, "\n").replace(/\r/g, "\n");

  return desc.trim();
}

function processDoc(doc, username){
  const item = {
    identifier: doc.identifier,
    title: doc.title || doc.identifier,
    creator: doc.creator || "Unknown",
    date: doc.publicdate || "N/A",
    desc: normalizeDescription(doc.description),
    tags: (doc.subject || []).toString(),
    mediaType: doc.mediatype || "unknown",
    directUrl: `https://archive.org/details/${doc.identifier}`,
    reviewUrl: `https://archive.org/details/${doc.identifier}#reviews`,
    username: username,
    thumbnailUrl: getArchiveThumbnail(doc.identifier)
  };

  return item;
}

function createCard(item) {
  let metaHtml = `
    <h3>${item.title}</h3>
    <div class="preview lazy-thumbnail" data-thumb="${item.thumbnailUrl}">
      <span style="color:#94a3b8;font-size:0.85rem;">Loading thumbnail‚Ä¶</span>
    </div>
    <div class="meta"><b>Identifier:</b> ${item.identifier}</div>
    <div class="meta"><b>Creator:</b> ${item.creator}</div>
    <div class="meta"><b>Public Date:</b> ${item.date}</div>
    <div class="meta"><b>Media Type:</b> ${item.mediaType}</div>
    <div class="meta"><b>Tags:</b> ${item.tags}</div>
  `;

  metaHtml += `
    <div class="meta description">
      <b>Description:</b><br>
      ${item.desc}
    </div>
    <div class="meta">
      <a href="${item.reviewUrl}" target="_blank" style="color:#60a5fa;">Reviews</a>
    </div>
    <div style="display: flex; gap: 0.5rem; align-items: center;">
      <button class="share-btn" onclick="shareItem('${item.username}', '${item.identifier}')">
        ·Øì‚û§ Share
      </button>
      <button class="open-btn" onclick="openViewer('${item.directUrl}')">
        ‚õ∂ Open Item
      </button>
    </div>
  `;

  const card = document.createElement("div");
  card.className = "card";
  card.innerHTML = metaHtml;
  return card;
}

function renderNextBatch(){
  const start = pageIndex * PAGE_SIZE;
  const end = start + PAGE_SIZE;
  const batch = visibleItems.slice(start, end);
  
  const fragment = document.createDocumentFragment();
  batch.forEach(item => {
    const card = createCard(item);
    fragment.appendChild(card);

    const thumbnail = card.querySelector(".lazy-thumbnail");
    if (thumbnail) thumbnailObserver.observe(thumbnail);
  });
  grid.appendChild(fragment);
  
  pageIndex++;
  
  if (end >= visibleItems.length) {
    loadMoreBtn.style.display = 'none';
  }
}

async function fetchAllItems(){
  const profileUrl = localStorage.getItem("current_profile_url");
  const avatarSrc = localStorage.getItem("current_profile_avatar");
  
  if(!profileUrl){
    log("‚ùå No profile selected");
    return;
  }

  grid.innerHTML = "";
  allItems = [];
  pageIndex = 0;

  if (avatarSrc) {
    profileAvatar.src = avatarSrc;
    profileAvatar.onclick = openAvatar;
  }

  const match = profileUrl.match(/@([^/]+)/);
  const username = match?.[1];
  if(!username){
    log("‚ùå Cannot extract username");
    return;
  }

  creatorName.textContent = username;

  const rows = 100;
  let page=1, fetched=0, total=0;

  while(true){
    log(`üì° Fetching page ${page}`);

    const searchUrl =
      `https://archive.org/advancedsearch.php?q=creator:@${username}` +
      `&fl[]=identifier&fl[]=title&fl[]=creator&fl[]=publicdate` +
      `&fl[]=mediatype&fl[]=description&fl[]=subject` +
      `&sort[]=publicdate desc&rows=${rows}&page=${page}&output=json`;

    const res = await fetch(searchUrl);
    const data = await res.json();

    if(page===1){
      total=data.response.numFound;
      log(`üì¶ Total items: ${total}`);
    }

    const docs = data.response.docs;
    if(!docs.length) break;

    const items = docs.map(doc => processDoc(doc, username));
    allItems = allItems.concat(items);
    visibleItems = [...allItems];

    fetched += docs.length;
    if(fetched>=total) break;
    page++;
  }

  renderNextBatch();
  loadMoreBtn.style.display = visibleItems.length > PAGE_SIZE ? 'block' : 'none';
  log(`‚úÖ Done. Loaded ${fetched} items.`);
}

function performSearch() {
  const searchTerm = searchInput.value.toLowerCase();
  const type = searchType.value;
  
  if (!searchTerm) {
    visibleItems = [...allItems];
    pageIndex = 0;
    grid.innerHTML = '';
    renderNextBatch();
    loadMoreBtn.style.display = visibleItems.length > PAGE_SIZE ? 'block' : 'none';
    return;
  }
  
  visibleItems = allItems.filter(item => {
    switch(type) {
      case 'title':
        return item.title.toLowerCase().includes(searchTerm);
      case 'subject':
        return item.tags.toLowerCase().includes(searchTerm);
      default:
        return false;
    }
  });
  
  pageIndex = 0;
  grid.innerHTML = '';
  renderNextBatch();
  loadMoreBtn.style.display = visibleItems.length > PAGE_SIZE ? 'block' : 'none';
}

function filterByMediaType() {
  const selectedType = mediaTypeFilter.value;
  
  if (!selectedType) {
    visibleItems = [...allItems];
    pageIndex = 0;
    grid.innerHTML = '';
    renderNextBatch();
    loadMoreBtn.style.display = visibleItems.length > PAGE_SIZE ? 'block' : 'none';
    return;
  }
  
  visibleItems = allItems.filter(item => 
    item.mediaType === selectedType
  );
  
  pageIndex = 0;
  grid.innerHTML = '';
  renderNextBatch();
  loadMoreBtn.style.display = visibleItems.length > PAGE_SIZE ? 'block' : 'none';
}

fetchAllItems();
</script>

</body>
</html>
